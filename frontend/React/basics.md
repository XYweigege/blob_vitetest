## å¥½æ–‡ç¿»è¯‘

### React key å±æ€§ï¼šé«˜æ€§èƒ½åˆ—è¡¨çš„æœ€ä½³å®è·µ

è¿™ç¯‡æ–‡ç« è®²çš„æ˜¯ React ä¸­çš„ keyã€‚ä¸€ä¸ªéå¸¸åŸºç¡€ï¼Œä½†åˆæ€»æ˜¯è®©äººâ€œç•¥æ‡‚â€çš„å±æ€§ã€‚ä¸å°‘äººçŸ¥é“åº”è¯¥ä½¿ç”¨å…·æœ‰å”¯ä¸€æ€§çš„ id ç»™å®ƒèµ‹å€¼ï¼Œä½†å¯¹å†…éƒ¨çš„å·¥ä½œç»†èŠ‚å¤šå°‘è¿˜æœ‰äº›æ¨¡æ¨¡ç³Šç³Šã€‚

#### å†™åœ¨å‰å¤´

React çš„ Â keyÂ  å±æ€§å¯èƒ½æ˜¯ React ä¸­ä½¿ç”¨æœ€å¤šçš„ â€œè‡ªåŠ¨é©¾é©¶ â€åŠŸèƒ½ä¹‹ä¸€ ğŸ˜…ã€‚æˆ‘ä»¬å½“ä¸­æœ‰è°èƒ½è¯šå®åœ°è¯´ï¼Œæˆ‘ä»¬ä»–ä»¬ä½¿ç”¨å®ƒæ˜¯å› ä¸º â€œ...æŸäº›åˆç†çš„åŸå› â€ï¼Œè€Œä¸æ˜¯å› ä¸º â€œeslint rule æ­£åœ¨é£™çº¢â€å‘¢ï¼Ÿ
æˆ‘æ€€ç–‘å¤§å¤šæ•°äººåœ¨é¢å¯¹ ã€Œä¸ºä»€ä¹ˆ React éœ€è¦ Â Â keyÂ  å±æ€§ ã€è¿™ä¸ªé—®é¢˜æ—¶ï¼Œä¼šå›ç­” â€œå‘ƒ......æˆ‘ä»¬åº”è¯¥æŠŠå”¯ä¸€å€¼æ”¾åœ¨é‚£é‡Œï¼Œè¿™æ · React æ‰èƒ½è¯†åˆ«åˆ—è¡¨é¡¹ï¼Œè¿™æ ·å¯¹æ€§èƒ½æ›´å¥½â€ã€‚ä»æŠ€æœ¯ä¸Šè®²ï¼Œè¿™ä¸ªç­”æ¡ˆæ˜¯æ­£ç¡®çš„ã€‚ ä½†æ˜¯ ã€Œè¯†åˆ«åˆ—è¡¨é¡¹ã€ åˆ°åº•æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿå¦‚æœæˆ‘è·³è¿‡ Â keyÂ  å±æ€§ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿåº”ç”¨ç¨‹åºä¼šå´©æºƒå—ï¼Ÿå¦‚æœæˆ‘åœ¨è¿™é‡Œè¾“å…¥ä¸€ä¸ªéšæœºå­—ç¬¦ä¸²ä¼šæ€æ ·ï¼Ÿå€¼çš„å”¯ä¸€æ€§å¦‚ä½•ï¼Ÿæˆ‘å¯ä»¥ä½¿ç”¨æ•°ç»„çš„ç´¢å¼•å€¼å—ï¼Ÿè¿™äº›é€‰æ‹©æœ‰ä»€ä¹ˆå½±å“ï¼Ÿå®ƒä»¬å¯¹æ€§èƒ½æœ‰ä»€ä¹ˆå½±å“ï¼Ÿ è®©æˆ‘ä»¬ä¸€èµ·æ¥ç ”ç©¶ä¸€ä¸‹å§ï¼

#### React key å±æ€§æ˜¯å¦‚ä½•å·¥ä½œçš„

é¦–å…ˆï¼Œåœ¨å¼€å§‹ç¼–ç ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆææ¸…æ¥šç†è®ºåªæ˜¯ï¼škeyÂ  å±æ€§æ˜¯ä»€ä¹ˆï¼Œä¸ºä»€ä¹ˆ React éœ€è¦å®ƒã€‚ ç®€è€Œè¨€ä¹‹ï¼Œå¦‚æœ Â keyÂ  å±æ€§å­˜åœ¨ï¼ŒReact å°±ä¼šåœ¨é‡æ¸²æŸ“æ—¶ä½¿ç”¨å®ƒæ¥è¯†åˆ«åŒç±»å‹å…ƒç´ 
æ¢å¥è¯è¯´ï¼Œåªæœ‰åœ¨é‡æ¸²æŸ“æ—¶ä¸ºäº†å’Œç›¸é‚»çš„åŒç±»å‹å…ƒç´ ï¼ˆå³æ‰å¹³åˆ—è¡¨ï¼‰åŒºåˆ†æ—¶ï¼Œæ‰éœ€è¦ key å±æ€§ï¼ˆè¿™ä¸€ç‚¹å¾ˆé‡è¦ï¼ï¼‰ã€‚

é‡æ¸²æŸ“è¿‡ç¨‹çš„ç®€åŒ–ç®—æ³•å¦‚ä¸‹ï¼š
é¦–å…ˆï¼ŒReact å°†ç”Ÿæˆå…ƒç´  ã€Œä¹‹å‰ã€å’Œ ã€Œä¹‹åã€çš„ å¿«ç…§ã€‚
å…¶æ¬¡ï¼ŒReact å°†å°è¯•è¯†åˆ«é¡µé¢ä¸­å·²ç»å­˜åœ¨çš„å…ƒç´ ï¼Œä»¥ä¾¿é‡æ–°ä½¿ç”¨å®ƒä»¬ï¼Œè€Œä¸æ˜¯ä»å¤´å¼€å§‹åˆ›å»ºã€‚

å¦‚æœ key å±æ€§å­˜åœ¨ï¼Œå®ƒå°†å‡å®šé‡æ¸²æŸ“ ã€Œä¹‹å‰ã€å’Œã€Œä¹‹åã€key ç›¸åŒçš„é¡¹æ˜¯ç›¸åŒçš„ã€‚
å¦‚æœ key å±æ€§ä¸å­˜åœ¨ï¼Œå®ƒå°†ä½¿ç”¨ç´¢å¼•ä½œä¸ºé»˜è®¤ keyã€‚

ç¬¬ä¸‰ï¼Œå®ƒä¼šï¼š

åˆ é™¤åœ¨é‡æ¸²æŸ“ã€Œä¹‹å‰ã€å­˜åœ¨ä½†ã€Œä¹‹åã€ä¸å­˜åœ¨çš„é¡¹ç›®â€”â€”å³å¸è½½ï¼ˆunmountï¼‰å®ƒä»¬ã€‚
ä»å¤´å¼€å§‹åˆ›å»ºåœ¨ã€Œä¹‹å‰ã€é˜¶æ®µä¸å­˜åœ¨çš„é¡¹ç›®â€”â€”å³åŠ è½½ï¼ˆmountï¼‰å®ƒä»¬ã€‚
æ›´æ–° ã€Œä¹‹å‰ã€å­˜åœ¨å¹¶åœ¨ ã€Œä¹‹åã€ç»§ç»­å­˜åœ¨çš„é¡¹ç›®â€”â€”å³é‡æ–°æ¸²æŸ“ï¼ˆrerenderï¼‰å®ƒä»¬ ã€‚

#### ä¸ºä»€ä¹ˆè¯´éšæœº key æ˜¯ç³Ÿç³•çš„å®è·µï¼Ÿ

è®©æˆ‘ä»¬å…ˆå®ç°ä¸€ä¸ªå›½å®¶åˆ—è¡¨ã€‚æˆ‘ä»¬å°†æœ‰ä¸€ä¸ª Item ç»„ä»¶ï¼Œæ¸²æŸ“å›½å®¶ä¿¡æ¯ï¼š

```jsx
const Item = ({ country }) => {
  return (
    <button className="country-item">
      <img src={country.flagUrl} />
      {country.name}
    </button>
  );
};
```

åŒæ—¶ï¼Œ CountriesList å®¹å™¨ç»„ä»¶æ¥æ¸²æŸ“çœŸæ­£çš„åˆ—è¡¨:

```jsx
const CountriesList = ({ countries }) => {
  return (
    <div>
      {countries.map((country) => (
        <Item country={country} />
      ))}
    </div>
  );
};
```

React ä¼šå‘ç°è¿™é‡Œæ²¡æœ‰ keyï¼Œäºæ˜¯ä¾¿ä¼šé€€å›åˆ°ä½¿ç”¨å›½å®¶æ•°ç»„çš„ç´¢å¼•ä½œä¸º keyã€‚
æˆ‘ä»¬çš„æ•°ç»„æ²¡æœ‰æ”¹å˜ï¼Œæ‰€ä»¥æ‰€æœ‰é¡¹ç›®éƒ½å°†è¢«è¯†åˆ«ä¸º "å·²ç»å­˜åœ¨"ï¼Œåˆ—è¡¨é¡¹å°†é‡æ¸²æŸ“ã€‚
ä»æœ¬è´¨ä¸Šè®²ï¼Œè¿™ä¸åœ¨ Item ä¸­æ˜ç¡®æ·»åŠ  key={index}æ²¡æœ‰åŒºåˆ«ã€‚

```jsx
countries.map((country, index) => <Item country={country} key={index} />);
```

ç°åœ¨æœ‰è¶£çš„éƒ¨åˆ†æ¥äº†ï¼šå¦‚æœæˆ‘ä»¬ä¸ä½¿ç”¨ç´¢å¼•ï¼Œè€Œæ˜¯åœ¨ key å±æ€§ä¸­å¡«å……ä¸€äº›éšæœºå­—ç¬¦ä¸²å‘¢ï¼Ÿ

```jsx
countries.map((country, index) => (
  <Item country={country} key={Math.random()} />
));
```

è¿™ç§æƒ…å†µä¸‹:

åœ¨æ¯æ¬¡é‡æ–°æ¸²æŸ“ CountriesList æ—¶ï¼ŒReact å°†é‡æ–°ç”Ÿæˆ key å±æ€§ã€‚
ç”±äº key å±æ€§æ˜¯å­˜åœ¨çš„ï¼ŒReact å°†ä½¿ç”¨å®ƒä½œä¸ºè¯†åˆ«ã€Œç°æœ‰ã€å…ƒç´ çš„ä¸€ç§æ–¹å¼ã€‚
ç”±äºæ‰€æœ‰çš„ key å±æ€§éƒ½æ˜¯æ–°çš„ï¼Œæ‰€æœ‰ "ä¹‹å‰" çš„é¡¹éƒ½å°†è¢«è§†ä¸º "å·²ç§»é™¤"ï¼Œæ¯ä¸ªé¡¹éƒ½å°†è¢«è§†ä¸º "æ–°çš„"ï¼Œæ‰€ä»¥ React å°† unmount æ‰€æœ‰åˆ—è¡¨é¡¹å¹¶å°†å®ƒä»¬é‡æ–° mount å›å»ã€‚

ç®€è€Œè¨€ä¹‹ï¼šå½“ CountriesList ç»„ä»¶é‡æ–°æ¸²æŸ“æ—¶ï¼Œæ¯ä¸ª Item éƒ½å°†è¢«é”€æ¯å¹¶ä»å¤´å¼€å§‹é‡æ–°åˆ›å»ºã€‚
å½“æˆ‘ä»¬è°ˆè®ºæ€§èƒ½æ—¶ï¼Œä¸ç®€å•çš„ re-render ç›¸æ¯”ï¼Œç»„ä»¶çš„é‡æ–°æŒ‚è½½è¦æ˜‚è´µå¾—å¤šã€‚æ­¤å¤–ï¼Œç”¨ React.memo åŒ…è£… Item æ‰€å¸¦æ¥çš„æ‰€æœ‰æ€§èƒ½æå‡éƒ½å°†æ¶ˆå¤±â€”â€”ç¼“å­˜å°†ä¸èµ·ä½œç”¨ï¼Œå› ä¸º Item å°†åœ¨æ¯æ¬¡é‡æ–°æ¸²æŸ“æ—¶é‡æ–°åˆ›å»ºã€‚
çœ‹çœ‹ codesandbox ä¸­çš„ä¸Šè¿°ç¤ºä¾‹ã€‚ç‚¹å‡»æŒ‰é’®é‡æ–°æ¸²æŸ“ï¼Œæ³¨æ„æ§åˆ¶å°è¾“å‡ºã€‚ç¨å¾®èŠ‚æµä¸€ä¸‹ CPUï¼Œç‚¹å‡»æŒ‰é’®æ—¶çš„å»¶è¿Ÿç”šè‡³å¯ä»¥ç”¨è‚‰çœ¼çœ‹åˆ°ï¼
å¦‚ä½•æ§åˆ¶ CPU èŠ‚æµï¼ˆthrottleï¼‰
åœ¨ Chrome æµè§ˆå™¨çš„å¼€å‘å·¥å…·ä¸­æ‰“å¼€ "æ€§èƒ½ "é€‰é¡¹å¡ï¼Œç‚¹å‡»å³ä¸Šè§’çš„ "é½¿è½® "å›¾æ ‡â€”â€”å®ƒå°†æ‰“å¼€ä¸€ä¸ªé¢å¤–çš„é¢æ¿ï¼Œ"CPU èŠ‚æµ "æ˜¯å…¶ä¸­çš„ä¸€ä¸ªé€‰é¡¹ã€‚

#### ä¸ºä»€ä¹ˆæŠŠç´¢å¼•ä½œä¸º key ä¹Ÿä¸æ˜¯å¥½ä¸»æ„ï¼Ÿ

ç°åœ¨ï¼Œæˆ‘ä»¬åº”è¯¥å¾ˆæ¸…æ¥šä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦åœ¨é‡æ¸²æŸ“æ—¶ç¨³å®šä¸å˜çš„ "key "å±æ€§äº†ã€‚ä½†æ˜¯æ•°ç»„çš„ "ç´¢å¼•"å‘¢ï¼Ÿå®˜æ–¹æ–‡æ¡£ä¸­å¹¶ä¸æ¨èä½¿ç”¨å®ƒä»¬ï¼Œç†ç”±æ˜¯å®ƒä»¬å¯èƒ½ä¼šå¯¼è‡´é”™è¯¯å’Œå½±å“æ€§èƒ½ã€‚ä½†æ˜¯å½“æˆ‘ä»¬ä½¿ç”¨ç´¢å¼•è€Œä¸æ˜¯æŸä¸ªå”¯ä¸€çš„ id æ—¶ï¼Œåˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆä¼šå¯¼è‡´ç³Ÿç³•çš„åæœå‘¢ï¼Ÿ
é¦–å…ˆï¼Œæˆ‘ä»¬ä¸ä¼šåœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­çœ‹åˆ°è¿™äº›é—®é¢˜ã€‚æ‰€æœ‰è¿™äº›é”™è¯¯å’Œå¯¹æ€§èƒ½çš„å½±å“åªå‘ç”Ÿåœ¨ "åŠ¨æ€"åˆ—è¡¨ä¸­â€”â€”åœ¨åˆ—è¡¨ä¸­ï¼Œé¡¹çš„é¡ºåºæˆ–æ•°é‡åœ¨é‡æ–°å‘ˆç°æ—¶ä¼šå‘ç”Ÿå˜åŒ–ã€‚ä¸ºäº†æ¨¡ä»¿è¿™ç§æƒ…å†µï¼Œè®©æˆ‘ä»¬ä¸ºåˆ—è¡¨å®ç°æ’åºåŠŸèƒ½ï¼š

```jsx
const CountriesList = ({ countries }) => {
  // å¼•å…¥æ’åºå€¼
  const [sort, setSort] = useState("asc");

  // æ ¹æ® state çš„å€¼ï¼Œä½¿ç”¨ lodash çš„ orderBy æ–¹æ³•æ¥ä¸ºå›½å®¶æ’åº
  const sortedCountries = orderBy(countries, "name", sort);

  // åŠ ä¸€ä¸ªæŒ‰é’®ï¼Œè®© state çš„å€¼åœ¨å‡åºé™åºé—´åˆ‡æ¢
  const button = (
    <button onClick={() => setSort(sort === "asc" ? "desc" : "asc")}>
      toggle sorting: {sort}
    </button>
  );

  return (
    <div>
      {button}
      {sortedCountries.map((country) => (
        <ItemMemo country={country} />
      ))}
    </div>
  );
};
```

æ¯å½“æˆ‘ç‚¹å‡»æŒ‰é’®ï¼Œæ•°ç»„çš„é¡ºåºå°±ä¼šé¢ å€’ã€‚æˆ‘å°†åˆ†åˆ«ä»¥ id å’Œ ç´¢å¼•ä½œä¸º key å®ç°åˆ—è¡¨ã€‚
ä»¥ country.id ä½œä¸º keyï¼š

```jsx
sortedCountries.map((country) => (
  <ItemMemo country={country} key={country.id} />
));
sortedCountries.map((country) => (
  <ItemMemo country={country} key={country.id} />
));
```
